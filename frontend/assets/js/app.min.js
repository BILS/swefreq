/*! swefreq 2017-11-02 */

angular.module("App",["ngRoute","ngCookies"]),angular.module("App").controller("datasetBeaconController",["$http","$routeParams","Beacon","Dataset","User",function(e,t,a,n,s){var r=this,o=t.dataset;r.queryResponses=[],a.getBeaconReferences(o).then(function(e){r.references=e}),s().then(function(e){r.user=e.data}),n(t.dataset,t.version).then(function(e){r.dataset=e.dataset},function(e){r.error=e}),r.search=function(){a.queryBeacon(r).then(function(e){d=e.data,d.query.position+=1,d.response.state=d.response.exists?"Present":"Absent",r.queryResponses.push(d)},function(e){r.queryResponses.push({response:{state:"Error"},query:{chromosome:r.chromosome,position:r.position,allele:r.allele,referenceAllele:r.referenceAllele,reference:r.reference}})})}}]),angular.module("App").controller("datasetDownloadController",["$http","$routeParams","User","Dataset","DatasetUsers","Log",function(e,t,a,n,s,r){function o(){i.hasOwnProperty("user")&&null!=i.user.user?i.hasOwnProperty("dataset")&&(i.authorization_level=i.dataset.authorization_level):i.authorization_level="loggedout"}var i=this,l=t.dataset;i.authorization_level="loggedout",e.get("/api/countries").success(function(e){i.availableCountries=e.countries}),a().then(function(e){i.user=e.data,o()}),n(t.dataset,t.version).then(function(e){i.dataset=e.dataset,o()},function(e){i.error=e});var u="/api/datasets/"+l+"/files";t.version&&(u="/api/datasets/"+l+"/versions/"+t.version+"/files"),e.get(u).success(function(e){i.files=e.files}),i.sendRequest=function(e){e&&s.requestAccess(l,i.user).success(function(e){i.authorization_level="thank-you"})},has_already_logged=!1,i.consented=function(){has_already_logged||(has_already_logged=!0,r.consent(l,i.dataset.version.version))}}]),angular.module("App").factory("User",function(e){return function(){return e.get("/api/users/me")}}),angular.module("App").factory("Dataset",function(e,t,a){return function(n,s){var r={dataset:null},o=t.defer();if(void 0===n)return o.reject("No dataset provided");var i="api/datasets/"+n;return s&&(i+="/versions/"+s),t.all([e.get(i).then(function(e){var t=e.data;t.version.description=a.trustAsHtml(t.version.description),t.version.terms=a.trustAsHtml(t.version.terms),r.dataset=t}),e.get("/api/datasets/"+n+"/collection").then(function(e){r.collections=e.data.collections,r.study=e.data.study,cn=r.study.contact_name,r.study.contact_name_uc=cn.charAt(0).toUpperCase()+cn.slice(1)})]).then(function(e){o.resolve(r)},function(e){var t="Can't find dataset "+n;s&&(t+=" version "+s),o.reject(t)}),o.promise}}),angular.module("App").factory("DatasetList",function(e,t,a){return function(){return t(function(t,n){e.get("/api/datasets").success(function(e){for(var n=e.data.length,s=[],r=0;r<n;r++)d=e.data[r],d.version.description=a.trustAsHtml(d.version.description),d.future?d.urlbase="/dataset/"+d.short_name+"/version/"+d.version.version:d.urlbase="/dataset/"+d.short_name,s.push(d);t(s)})})}}),angular.module("App").factory("Beacon",function(e,t){function a(e){for(var t=[],a=0;a<n.data.datasets.length;a++)dataset=n.data.datasets[a],dataset.id==e&&t.push(dataset.reference);return t}var n={};return n.getBeaconReferences=function(s){var r=t.defer();return n.hasOwnProperty("id")?r.resolve(a(s)):e.get("/api/beacon/info").success(function(e){n.data=e,r.resolve(a(s))}),r.promise},n.queryBeacon=function(t){return e.get("/api/beacon/query",{params:{chrom:t.chromosome,pos:t.position-1,allele:t.allele,referenceAllele:t.referenceAllele,dataset:t.dataset.short_name,ref:t.reference}})},n}),angular.module("App").controller("datasetController",["$http","$routeParams","User","Dataset",function(e,t,a,n){var s=this;t.dataset;a().then(function(e){s.user=e.data}),n(t.dataset,t.version).then(function(e){s.dataset=e.dataset,s.collections=e.collections,s.study=e.study},function(e){s.error=e})}]),angular.module("App").factory("DatasetVersions",function(e,t){return function(a){return t(function(t,n){e.get("/api/datasets/"+a+"/versions").then(function(e){t(e.data.data)})})}}),angular.module("App").config(function(e,t){e.when("/",{templateUrl:"static/templates/ng-templates/home.html"}).when("/dataBeacon/",{templateUrl:"static/templates/ng-templates/dataBeacon.html"}).when("/dataset/:dataset",{templateUrl:"static/templates/ng-templates/dataset.html"}).when("/dataset/:dataset/terms",{templateUrl:"static/templates/ng-templates/dataset-terms.html"}).when("/dataset/:dataset/download",{templateUrl:"static/templates/ng-templates/dataset-download.html"}).when("/dataset/:dataset/beacon",{templateUrl:"static/templates/ng-templates/dataset-beacon.html"}).when("/dataset/:dataset/admin",{templateUrl:"static/templates/ng-templates/dataset-admin.html"}).when("/dataset/:dataset/version/:version",{templateUrl:"static/templates/ng-templates/dataset.html"}).when("/dataset/:dataset/version/:version/terms",{templateUrl:"static/templates/ng-templates/dataset-terms.html"}).when("/dataset/:dataset/version/:version/download",{templateUrl:"static/templates/ng-templates/dataset-download.html"}).when("/dataset/:dataset/version/:version/beacon",{templateUrl:"static/templates/ng-templates/dataset-beacon.html"}).otherwise({templateUrl:"static/templates/ng-templates/404.html"}),t.html5Mode(!0)}),angular.module("App").directive("consent",function(e){return{scope:{},template:'<div style="position: relative; z-index: 1000"><div style="background: #eee; position: fixed; bottom: 0; left: 0; right: 0; height: 20px" ng-hide="consent()"><span style="margin-left: 5px;">This site uses cookies, please see our <a href="https://swefreq.nbis.se/#/privacyPolicy/">privacy policy</a>, ok, I <a href="" ng-click="consent(true)">agree.</a></span><span style="float: right;margin-right: 5px;"><a href="" ng-click="consent(true)">X</a></span></div></div>',controller:function(t){var a=e.get("consent");t.consent=function(t){if(void 0===t)return a;t&&(e.put("consent",!0),a=!0)}}}}),angular.module("App").controller("navbarController",["$routeParams","Dataset","DatasetVersions",function(e,t,a){var n=this;n.is_admin=!1,t(e.dataset,e.version).then(function(t){n.is_admin=t.dataset.is_admin,n.dataset=t.dataset.short_name,n.browser_uri=t.dataset.browser_uri,n.urlBase="/dataset/"+n.dataset,n.thisVersion=t.dataset.version.version,e.version&&(n.urlBase+="/version/"+e.version),a(n.dataset).then(function(e){for(var t=0;t<e.length;t++)if(e[t].name==n.thisVersion){e[t].active=!0;break}n.versions=e})}),n.createUrl=function(e,t){return"admin"==e?"/dataset/"+n.dataset+"/"+e:("main"==e&&(e=""),t?"/dataset/"+n.dataset+"/version/"+t+"/"+e:n.urlBase+"/"+e)}}]),angular.module("App").controller("mainController",["$location","User",function(e,t){var a=this;a.url=function(){return e.path()},a.logged_in=!1,t().then(function(e){a.user=e.data,null!==a.user.user&&(a.logged_in=!0)})}]),angular.module("App").controller("homeController",["$http","$sce","DatasetList",function(e,t,a){var n=this;n.datasets=[],a().then(function(e){n.datasets=e})}]),angular.module("App").controller("datasetAdminController",["$http","$routeParams","User","Dataset","DatasetUsers",function(e,t,a,n,s){function r(){s.getUsers(i).then(function(e){o.users=e})}var o=this,i=t.dataset;r(),a().then(function(e){o.user=e.data}),n(t.dataset,t.version).then(function(e){o.dataset=e.dataset},function(e){o.error=e}),o.revokeUser=function(e){s.revokeUser(i,e.email).success(function(e){r()})},o.approveUser=function(e){s.approveUser(i,e.email).success(function(e){r()})}}]),angular.module("App").factory("DatasetUsers",function(e,t,a){var n={};return e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",n.getUsers=function(t){var n=a.defer(),s={pending:[],current:[]};return a.all([e.get("/api/datasets/"+t+"/users_pending").then(function(e){s.pending=e.data.data}),e.get("/api/datasets/"+t+"/users_current").then(function(e){s.current=e.data.data})]).then(function(e){n.resolve(s)}),n.promise},n.approveUser=function(a,n){return e.post("/api/datasets/"+a+"/users/"+n+"/approve",$.param({_xsrf:t.get("_xsrf")}))},n.revokeUser=function(a,n){return e.post("/api/datasets/"+a+"/users/"+n+"/revoke",$.param({_xsrf:t.get("_xsrf")}))},n.requestAccess=function(a,n){return e({url:"/api/datasets/"+a+"/users/"+n.email+"/request",method:"POST",data:$.param({email:n.email,userName:n.userName,affiliation:n.affiliation,country:n.country.name,_xsrf:t.get("_xsrf"),newsletter:n.newsletter?1:0})})},n}),angular.module("App").factory("Log",function(e,t){var a={};return e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",a.consent=function(a,n){return e.post("/api/datasets/"+a+"/log/consent/"+n,$.param({_xsrf:t.get("_xsrf")}))},a});